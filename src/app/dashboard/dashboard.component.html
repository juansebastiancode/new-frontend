<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<div class="dashboard-container">
  <!-- Contenido principal sin menú -->
  <div class="main-content no-menu">
    <div class="hero">
      <div class="user-header">
        <div class="user-info" (click)="toggleUserDropdown()">
          <div class="user-avatar">
            <div class="avatar-circle">
              <img *ngIf="!imageError && (auth.getCurrentUser()?.photoURL)" [src]="auth.getCurrentUser()?.photoURL || ''" [alt]="userName" class="avatar-image" referrerpolicy="no-referrer" (error)="onImageError()">
              <div *ngIf="imageError || !(auth.getCurrentUser()?.photoURL)" class="avatar-text">{{ userInitial }}</div>
            </div>
          </div>
          <div class="user-details">
            <div class="user-name">{{ userName }}</div>
            <div class="user-plan">Gratis</div>
          </div>
          <div class="dropdown-arrow">
            <i class="fas fa-chevron-down" [class.rotated]="showUserDropdown"></i>
          </div>
        </div>
          <div class="user-dropdown" *ngIf="showUserDropdown" (click)="$event.stopPropagation()">
          <div class="dropdown-item" (click)="goToProfile()">
            <i class="fas fa-user"></i>
            <span>Mi Perfil</span>
          </div>
          <div class="dropdown-item" (click)="logout()">
            <i class="fas fa-right-from-bracket"></i>
            <span>Cerrar Sesión</span>
          </div>
        </div>
      </div>
      <h1>Plan B2B</h1>
      <div class="tabs">
        <button class="tab" [class.active]="activeTab==='projects'" (click)="selectTab('projects')">Mis proyectos</button>
        <button class="tab" [class.active]="activeTab==='invitations'" (click)="selectTab('invitations')">Invitaciones</button>
      </div>
      <div class="actions">
        <div class="search-wrap">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="m21 21-4.35-4.35m0 0A7.5 7.5 0 1 0 5.65 5.65a7.5 7.5 0 0 0 10.6 10.6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input class="search" type="text" [placeholder]="activeTab==='projects' ? 'Buscar proyectos...' : 'Buscar invitaciones...'" [(ngModel)]="searchQuery" (input)="onSearchChange()" />
        </div>
        <button class="primary" *ngIf="activeTab==='projects'" (click)="createProject()">Crear proyecto</button>
      </div>
      
    </div>
    
    <!-- Modal crear proyecto -->
    <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeModal()"></div>
    <div class="modal-card" *ngIf="showCreateModal" (click)="$event.stopPropagation()">
      <h3>Crear proyecto</h3>
      <div class="form-row">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="projectName" placeholder="Ej. Mi nuevo proyecto" />
      </div>
      <div class="form-row">
        <label>Sector</label>
        <input type="text" [(ngModel)]="projectSector" placeholder="Ej. Restauración" />
      </div>
      <div class="modal-actions">
        <button class="ghost" (click)="closeModal()">Cancelar</button>
        <button class="primary" [disabled]="!projectName" (click)="confirmCreate()">Crear</button>
      </div>
    </div>
    
    <div class="projects-wrap" *ngIf="activeTab==='projects'">
      <div class="projects-header">
        <span class="muted" *ngIf="loadingProjects"></span>
        <span class="error" *ngIf="loadError">{{ loadError }}</span>
      </div>
      <div class="projects" *ngIf="filteredProjects?.length; else emptyState">
        <div class="project-card" *ngFor="let p of filteredProjects" (click)="openProject(p)" style="cursor:pointer;">
          <div class="project-header">
            <div>
              <h4>{{ p.name }}</h4>
              <div class="meta">{{ p.sector || 'Sin sector' }} · {{ p.createdAt | date:'short' }}</div>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyState>
        <div class="empty" *ngIf="loadingProjects">
          <div class="spinner"></div>
        </div>
        <div class="empty" *ngIf="!loadingProjects && !searchQuery">No tienes proyectos todavía. Crea el primero.</div>
        <div class="empty" *ngIf="!loadingProjects && searchQuery">Sin resultados para "{{ searchQuery }}".</div>
      </ng-template>
    </div>

    <div class="invitations-wrap" *ngIf="activeTab==='invitations'">
      <!-- Invitaciones pendientes -->
      <div class="invitations" *ngIf="filteredInvitations && filteredInvitations.length > 0">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #111;">Invitaciones pendientes</h3>
        <div class="invitations-grid">
          <div class="invitation-card" *ngFor="let inv of filteredInvitations">
            <div class="inv-header">
              <div class="inv-project-name" *ngIf="inv.projectId_data">{{ inv.projectId_data.name }}</div>
              <div class="inv-project-name" *ngIf="!inv.projectId_data">Proyecto</div>
              <div class="inv-inviter">Invitado por: {{ inv.inviterEmail }}</div>
            </div>
            <div class="inv-meta">{{ inv.createdAt | date:'short' }}</div>
            <div class="inv-actions">
              <button class="ghost danger" (click)="rejectInvitation(inv)">Rechazar</button>
              <button class="primary" (click)="acceptInvitation(inv)">Aceptar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Proyectos donde fuiste invitado (ya aceptados) -->
      <div class="invited-projects-section" *ngIf="filteredInvitedProjects && filteredInvitedProjects.length > 0">
        <h3 style="font-size: 16px; font-weight: 600; margin: 20px 0 12px 0; color: #111;">Proyectos donde participas</h3>
        <div class="projects">
          <div class="project-card" *ngFor="let p of filteredInvitedProjects">
            <div class="project-header">
              <div style="flex: 1; cursor: pointer;" (click)="openProject(p)">
                <h4>{{ p.name }}</h4>
                <div class="meta">{{ p.sector || 'Sin sector' }} · {{ p.createdAt | date:'short' }}</div>
              </div>
              <div class="dropdown-wrapper">
                <button class="more-options-btn" (click)="toggleDropdown(p, $event)" title="Opciones">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="options-dropdown" *ngIf="openDropdownId === getProjectId(p)">
                  <div class="dropdown-option danger" (click)="leaveProject(p, $event)">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Abandonar proyecto</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estado vacío -->
      <div class="empty" *ngIf="!loadingInvitations && !filteredInvitations?.length && !filteredInvitedProjects?.length">
        No tienes invitaciones ni proyectos compartidos.
      </div>
      <div class="empty" *ngIf="loadingInvitations">
        <div class="spinner"></div>
      </div>
    </div>

    <app-profile *ngIf="showProfile" (closeProfile)="closeProfile()"></app-profile>
  </div>
</div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  .dashboard-container {
    width: 100%;
    height: 100vh;
    background: white;
    position: relative;
  }

  .main-content { height: 100vh; background: white; }
  .main-content.no-menu { margin-left: 0; }

  .hero {
    max-width: 960px;
    margin: 0 auto;
    padding: 48px 24px;
  }
  .user-header { position: absolute; top: 14px; right: 20px; }
  .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px 12px; border-radius: 9px; transition: background .2s; }
  .user-info:hover { background: rgba(0,0,0,0.04); }
  .user-avatar .avatar-circle { width: 34px; height: 34px; border-radius: 50%; overflow: hidden; background: #f0f0f0; }
  .avatar-image { width: 100%; height: 100%; object-fit: cover; }
  .avatar-text { color: #fff; background: linear-gradient(180deg,#ffb36b 0%, #ff7043 100%); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 13px; font-weight: 700; }
  .user-name { font-size: 13px; color: #333; font-weight: 500; line-height: 1.1; }
  .user-plan { font-size: 11px; color: #666; margin-top: 1px; }
  
  .dropdown-arrow { 
    margin-left: 8px; 
    color: #666; 
    font-size: 12px; 
    transition: transform 0.2s ease, color 0.2s ease;
  }
  .dropdown-arrow i.rotated { transform: rotate(180deg); }
  .user-info:hover .dropdown-arrow { color: #333; }
  .user-dropdown { position: absolute; right: 24px; top: 52px; background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); overflow: hidden; min-width: 180px; border: 1px solid #e9e9e9; }
  .user-dropdown .dropdown-item { display: flex; align-items: center; gap: 8px; padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #f3f3f3; }
  .user-dropdown .dropdown-item:last-child { border-bottom: none; }
  .user-dropdown .dropdown-item:hover { background: #f8f9fa; }
  .user-dropdown .dropdown-item i { color: #333; width: 14px; text-align: center; font-size: 12px; }
  .user-dropdown .dropdown-item span { font-size: 13px; }
  .hero h1 {
    font-size: 48px;
    letter-spacing: 1px;
    margin-bottom: 24px;
    color: #111;
  }
  .actions { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
  .actions .search-wrap { flex: 1; }
  .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
  .tab { border: 1px solid #ddd; background: #fff; color: #111; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 13px; }
  .tab.active { background: #111; color: #fff; border-color: #111; }
  .primary {
    background: #111;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    white-space: nowrap; /* evita salto de línea */
  }
  .primary:hover { opacity: 0.9; }
  .search {
    flex: 1;
    min-width: 240px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 14px;
    outline: none;
  }
  .search-wrap { position: relative; display: flex; align-items: center; width: 100%; }
  .search-icon { position: absolute; left: 12px; pointer-events: none; color: #888; }
  .search-wrap .search { padding-left: 36px; }
  .helper { margin-top: 12px; color: #666; font-size: 14px; }

  /* Grid de proyectos */
  .projects {
    max-width: 960px;
    margin: 12px auto 0 auto;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }
  .project-card {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 14px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .project-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  .project-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }
  .project-card h4 { margin: 0 0 6px 0; font-size: 16px; }
  .project-card .meta { color: #777; font-size: 12px; }
  .leave-project-btn {
    background: transparent;
    border: 1px solid #ef4444;
    border-radius: 6px;
    padding: 6px 10px;
    color: #ef4444;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  .leave-project-btn:hover {
    background: #fee2e2;
    border-color: #dc2626;
    color: #dc2626;
  }
  .leave-project-btn i {
    font-size: 12px;
  }
  .dropdown-wrapper { position: relative; }
  .more-options-btn {
    background: transparent;
    border: none;
    padding: 4px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .more-options-btn:hover {
    color: #333;
  }
  .more-options-btn i { font-size: 14px; }
  .options-dropdown {
    position: absolute;
    right: -180px;
    bottom: 100%;
    margin-bottom: 4px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    min-width: 180px;
    overflow: hidden;
  }
  .dropdown-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s ease;
  }
  .dropdown-option:hover { background: #f5f5f5; }
  .dropdown-option.danger { color: #ef4444; }
  .dropdown-option.danger:hover { background: #fee2e2; }
  .dropdown-option i { width: 14px; text-align: center; font-size: 12px; }
  .projects-wrap { max-width: 960px; margin: 4px auto 0 auto; padding: 0 24px; }
  .projects-header { display: flex; align-items: center; gap: 12px; }
  .projects-header h3 { margin: 0; font-size: 18px; }
  .muted { color: #777; font-size: 13px; }
  .error { color: #c00; font-size: 13px; }
  .empty { color: #777; font-size: 14px; padding: 12px 0; }
  .spinner { width: 24px; height: 24px; border: 3px solid #eee; border-top-color: #111; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 12px auto; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .invitations-wrap { max-width: 960px; margin: 4px auto 0 auto; padding: 0 24px; }
  .invitations { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .invitation-card { border: 1px solid #ccc; border-radius: 10px; padding: 14px; background: #fff; display: flex; flex-direction: column; gap: 8px; transition: transform .15s ease, box-shadow .15s ease; }
  .invitation-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  .inv-header { margin-bottom: 4px; }
  .inv-project-name { font-weight: 600; font-size: 15px; color: #111; margin-bottom: 4px; }
  .inv-inviter { color: #777; font-size: 12px; }
  .inv-email { font-weight: 600; }
  .inv-meta { color: #777; font-size: 12px; }
  .inv-actions { display: flex; gap: 8px; margin-top: 4px; }
  .ghost.danger { border-color: #ef4444; color: #ef4444; }
  .ghost.danger:hover { background: #fee2e2; }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
  }
  .modal-card {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 560px;
    max-width: calc(100% - 32px);
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .modal-card h3 { margin: 0 0 4px 0; }
  .form-row { display: flex; flex-direction: column; gap: 6px; }
  .form-row label { font-size: 13px; color: #666; }
  .form-row input {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 12px;
    outline: none;
  }
  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
  .ghost {
    background: transparent;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 14px;
    cursor: pointer;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main-content { margin-left: 0; }
  }
</style>